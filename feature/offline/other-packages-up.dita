<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "urn:pubid:zenoss.com:doctypes:dita:dtd:task" "task.dtd">
<task id="taskid">
  <title>Optional: Downloading and updating cluster software</title>
  <taskbody>
    <prereq>To perform this procedure, you need:
      <ul>
        <li>An RHEL/CentOS system with internet access and the same operating system release and
          kernel as the master host nodes.</li>
        <li>A secure network copy program.</li>
      </ul>
    </prereq>
    <context>Use this procedure to update Distributed Replicated Block Device (DRBD)
      and Pacemaker/Corosync, if desired. 
      <p>Follow these steps to download and install the packages on master host nodes:</p>
    </context>
    <steps>
      <step>
        <cmd>Log in to a compatible host that is connected to the internet <ph
            conkeyref="strings/login-root"/>.</cmd>
        <info>The host must have the same operating system (RHEL or CentOS) and release installed,
          and the same version of the Linux kernel, as the master host nodes.</info>
      </step>
      
      <step>
        <cmd>Install <cmdname>yum</cmdname> utilities, if necessary.</cmd>
        <substeps>
          <substep>
            <cmd>Determine whether the <cmdname>yum</cmdname> utilities package is installed.</cmd>
            <stepxmp>
              <codeblock>rpm -qa | grep yum-utils</codeblock>
            </stepxmp>
            <stepresult>
              <ul>
                <li>If the command returns a result, the package is installed. Proceed to the next step.</li>
                <li>If the command does not return a result, the package is not installed. Perform the following substep.</li>
              </ul>
            </stepresult>
          </substep>
          <substep>
            <cmd>Install the <codeph>yum-utils</codeph> package.</cmd>
            <stepxmp>
              <codeblock>yum install -y yum-utils</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>Add the Enterprise Linux packages repository (ELRepo), if necessary.</cmd>
        <substeps>
          <substep>
            <cmd>Determine whether the ELRepo repository is available.</cmd>
            <stepxmp>
              <codeblock>yum repolist | grep elrepo</codeblock>
            </stepxmp>
            <stepresult>
              <ul>
                <li>If the command returns a result, the repository is available. Proceed to the next step.</li>
                <li>If the command does not return a result, the repository is not available. Perform the following substeps.</li>
              </ul>
            </stepresult>
          </substep>
          <substep>
            <cmd>Import the public key for the repository.</cmd>
            <stepxmp>
              <codeblock>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Add the repository to the download host.</cmd>
            <stepxmp>
              <codeblock>rpm -Uvh \
  http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Clean and update the <cmdname>yum</cmdname> caches.</cmd>
            <stepxmp>
              <codeblock>yum clean all &#38;&#38; yum makecache fast</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>Download the required packages and their dependencies, and then create a 
          <cmdname>tar</cmdname> archive of the package files.</cmd>
        <substeps>
          <substep>
            <cmd>Create a temporary directory for the packages.</cmd>
            <stepxmp>
              <codeblock>mkdir /tmp/downloads</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Download the DRBD packages to the temporary directory.</cmd>
            <stepxmp>
              <codeblock>repotrack -a x86_64 -r elrepo -p /tmp/downloads kmod-drbd84</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Download the Corosync/Pacemaker packages to the temporary directory.</cmd>
            <stepxmp>
              <codeblock>repotrack -a x86_64 -p /tmp/downloads pcs</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Create a <cmdname>tar</cmdname> archive of the temporary directory.</cmd>
            <stepxmp>
              <codeblock>cd /tmp &#38;&#38; tar czf ./downloads.tgz ./downloads</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>Use a secure copy program to copy the packages archive to 
          the <filepath>/tmp</filepath> directory of each master host node.</cmd>
      </step>
      
      <step>
        <cmd>Log in to the primary node <ph conkeyref="strings/login-root"/>.</cmd>
      </step>
      
      <step>
        <cmd>In a separate window, log in to the secondary node <ph conkeyref="strings/login-root"
        />.</cmd>
      </step>
      
      <step>
        <cmd>On both nodes, stop the cluster software.</cmd>
        <substeps>
          <substep>
            <cmd>Stop the PCS daemon.</cmd>
            <stepxmp>
              <codeblock>systemctl stop pcsd.service</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Stop DRBD.</cmd>
            <stepxmp>
              <codeblock>drbdadm down all</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>On both nodes, extract and install the cluster management packages.</cmd>
        <substeps>
          <substep>
            <cmd>Extract the packages.</cmd>
            <stepxmp>
              <codeblock>cd /tmp &#38;&#38; tar xzf ./downloads.tgz</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Install the packages.</cmd>
            <stepxmp>
              <codeblock>yum --disablerepo=\* install -y ./downloads/*.rpm</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>On both nodes, install the Pacemaker resource agents for <ph keyref="nm-cc"/>.</cmd>
        <stepxmp>
          <codeblock>yum install -y --disablerepo=\* \
  /opt/zenoss-repo-mirror/serviced-resource-agents-*.x86_64.rpm</codeblock>
        </stepxmp>
      </step>
      
      <step>
        <cmd>On both nodes, start the cluster software.</cmd>
        <substeps>
          <substep>
            <cmd>Start DRBD.</cmd>
            <stepxmp>
              <codeblock>drbdadm up all</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Start the PCS daemon.</cmd>
            <stepxmp>
              <codeblock>systemctl start pcsd.service</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
    </steps>
  </taskbody>
</task>
