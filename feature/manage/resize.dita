<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "urn:pubid:zenoss.com:doctypes:dita:dtd:task" "task.dtd">
<task id="taskid">
  <title>Adding space to a device</title>
  <taskbody>
 <!-- updates for cc_3375 in upgrade guide -->
    <context>
      <p><ph keyref="nm-cc"/> uses an LVM thin pool to store tenant (application) data. Each thin
        pool includes a separate storage area for data and a separate storage area for metadata. In
        addition, <ph keyref="nm-cc"/> maintains separate virtual devices for each tenant it
        manages.</p>
      
      <p>To ensure consistency, <ph keyref="nm-cc"/> requires the following, minimum 
        free space in its thin pool:
      <ul>
        <li>3GB in the data storage area</li>
        <li>62MB in the metadata storage area</li>
        <li>3GB for each tenant volume</li>
      </ul>So, if <ph keyref="nm-cc"/> is managing two applications, it requires a minimum of
        62MB of free space in the metadata storage area and 6GB of storage in the data
        storage area.</p>

      <p>Use this procedure to check the amount of free space and if necessary, increase the size of an
        existing virtual device.</p>
    </context>
    
    <steps>
      <step>
        <cmd>Log in to the master host <ph conkeyref="strings/login-root"/>.</cmd>
      </step>
      
      <step>
        <cmd>Display the amount of space available in the <cmdname>serviced</cmdname>
          thin pool, and then increase it, if necessary.</cmd>
        <stepxmp>
          <codeblock>serviced volume status</codeblock>
        </stepxmp>
        <info>The result includes detailed information about the <cmdname>serviced</cmdname> thin
          pool and about the thin pool and each tenant virtual device. If the thin pool does not
          have enough space, perform the following substeps.</info>
        <substeps>
          <substep>
            <cmd>Identify the volume group to which the <cmdname>serviced</cmdname> thin pool belongs.</cmd>
            <stepxmp>
              <codeblock>lvs --options=lv_name,vg_name,lv_size</codeblock>
            </stepxmp>
            <stepresult>The volume group associated with <codeph>serviced-pool</codeph> 
              contains the <cmdname>serviced</cmdname> thin pool.</stepresult>
          </substep>
          <substep>
            <cmd>Display the amount of unused space in the volume group.</cmd>
            <stepxmp>Replace <varname>Volume-Group-Name</varname> with the name of the
              volume group that contains the <cmdname>serviced</cmdname> thin pool:
              <codeblock>vgs --no-headings --options=vg_free <varname>Volume-Group-Name</varname></codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>If the volume group contains the amount of free space you want to add the
                <cmdname>serviced</cmdname> thin pool, proceed to the next substep. If not, before
              continuing with this procedure, add physical or logical storage to the volume
              group.</cmd>
          </substep>
          <substep>
            <cmd>Add storage to the <cmdname>serviced</cmdname> thin pool.</cmd>
            <stepxmp>Replace <varname>Size</varname> with the amount of space to add to the
                <cmdname>serviced</cmdname> thin pool, and replace
                <varname>Volume-Group-Name</varname> with the name of the volume group that contains
              the <cmdname>serviced</cmdname> thin pool.
              <codeblock>lvextend -L+<varname>Size</varname>G <varname>Volume-Group-Name</varname>/serviced-pool</codeblock>
            </stepxmp>
          </substep>
          <!-- Added by RP for CC-3383, backed out by GE. I'm not so sure we should
               include this...I'd like to see developer confirmation it's needed first.
          <substep>
            <cmd>Add storage to the <cmdname>serviced</cmdname> metadata volume:</cmd>
            <stepxmp>Replace <varname>Size</varname> with the amount of space to add.
              <codeblock>lvextend -L+<varname>Size</varname>M serviced/serviced-pool_tmeta</codeblock>
            </stepxmp>
          </substep>
           -->
        </substeps>
      </step>
      
      <step>
        <cmd>Increase the size of an existing tenant device.</cmd>
        <substeps>
          <substep>
            <cmd>Identify the tenant device to resize.</cmd>
            <stepxmp>
              <codeblock>serviced volume status</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Increase the size of the tenant device.</cmd>
            
            <stepxmp>In the following command:
              <ul>
                <li>Replace <varname>Volume-Group-Name</varname> with the name of the
                  volume group that contains the <cmdname>serviced</cmdname> thin pool.</li>
                <li>Replace <varname>Tenant-Device-ID</varname> with the identifier of the tenant
                  device.</li>
                <li>Replace <varname>Total-Device-Size</varname> with the sum of
                the existing device size plus the space to add to the device, in
                gigabytes.</li>
              </ul>
              <codeblock>serviced-storage resize -d /opt/serviced/var/volumes \
  -o dm.thinpooldev=/dev/mapper/<varname>Volume-Group-Name</varname>-serviced--pool \
  <varname>Tenant-Device-ID</varname> <varname>Total-Device-Size</varname>G</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      
    </steps>
  </taskbody>
</task>
