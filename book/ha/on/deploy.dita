<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "urn:pubid:zenoss.com:doctypes:dita:dtd:task" "task.dtd">
<task id="taskid">
  <title>Deploying <ph keyref="nm-platform"/></title>
  <taskbody>
    <context>This procedure adds all of the resource pool hosts to the
      <ph keyref="nm-cc"/> cluster, and then deploys the <ph keyref="nm-platform"/>
    application.</context>
    <steps>
      
      <step>
        <cmd>Use the virtual hostname (<varname>HA-Virtual-Name</varname>) or
          virtual IP address (<varname>HA-Virtual-IP</varname>) of the 
          high-availability cluster to start a Bash shell on the <ph keyref="nm-cc"/> 
          master host <ph conkeyref="strings/login-root"/>.</cmd>
      </step>
      
      <step>
        <cmd>Display the public hostname of the current node.</cmd>
        <stepxmp>
          <codeblock>uname -n</codeblock>
        </stepxmp>
        <stepresult>The result is either <varname>Primary-Public-Name</varname>
          or <varname>Secondary-Public-Name</varname>.
        </stepresult>
      </step>
      
      <step>
        <cmd>Place the other node in standby mode.</cmd>
        <info>This avoids potential conflicts and errors in the event of 
          an unexpected <cmdname>serviced</cmdname> shutdown during the initial deployment.</info>
        <stepxmp>
          <p>Replace <varname>Other-Node-Hostname</varname> with the public hostname
            of the other node:</p>
          <codeblock>pcs cluster standby <varname>Other-Node-Hostname</varname></codeblock>
        </stepxmp>
      </step>
      
      <step>
        <cmd>Add resource pool hosts to resource pools.</cmd>
        <stepxmp>
          <p>Replace <varname>Hostname-Or-IP</varname> with the hostname 
            or IP address of the resource pool host to add, and
            replace <varname>Resource-Pool-Name</varname> with the
            name of a resource pool created previously, or with
            <codeph>default</codeph>:</p>
          
          <codeblock>serviced host add <varname>Hostname-Or-IP</varname>:4979 <varname>Resource-Pool-Name</varname></codeblock>
          
          <p>If you enter a hostname, all hosts in your <ph keyref="nm-cc"/>
            cluster must be able to resolve the name, either
            through an entry in <filepath>/etc/hosts</filepath>, or through a 
            nameserver on your network.</p>
        </stepxmp>
        <info>Repeat this step for each resource pool host in your deployment.</info>
      </step>
      
      <step>
        <cmd>Add the <codeph>Zenoss.resmgr</codeph> application
          to <ph keyref="nm-cc"/>.</cmd>
        <stepxmp>
          <codeblock>myPath=/opt/serviced/templates
serviced template add $myPath/zenoss-resmgr-*.json</codeblock>
        </stepxmp>
        <stepresult>On success, the <cmdname>serviced</cmdname> 
          command returns the template ID.</stepresult>
      </step>

      <step>
        <cmd>Deploy the application.</cmd>
        <stepxmp>
          <p>Replace <varname>Template-ID</varname> with the 
            template identifier returned in the
          previous step, and replace <varname>Deployment-ID</varname> 
            with a name for this deployment (for example, 
            <codeph>Dev</codeph> or <codeph>Test</codeph>):</p>
          <codeblock>serviced template deploy <varname>Template-ID</varname> default <varname>Deployment-ID</varname></codeblock>
        </stepxmp>
        <stepresult>
          <p><ph keyref="nm-cc"/> pulls <ph keyref="nm-platform"/> images into the local registry.
            To monitor progress, open a separate window, and enter the following command:</p>
          <codeblock>journalctl -flu serviced -o cat</codeblock>
        </stepresult>
      </step>
      
      <step>
        <cmd>Restore the cluster.</cmd>
        <stepxmp>
          <p>Replace <varname>Standby-Node-Hostname</varname> with the public hostname
            of the node that is in standby mode:</p>
          <codeblock>pcs cluster unstandby <varname>Standby-Node-Hostname</varname></codeblock>
        </stepxmp>
      </step>
    </steps>
  </taskbody>
</task>
