<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE task PUBLIC "urn:pubid:zenoss.com:doctypes:dita:dtd:task" "task.dtd">
<task id="taskid">
  <title>Starting <ph keyref="nm-cc"/> and verifying the cluster</title>
  <taskbody>
    <context>Use this procedure to start <ph keyref="nm-cc"/> and verify the cluster.</context>
    
    <steps>
      <step>
        <cmd>Use the virtual hostname or virtual IP address of the high-availability cluster to log
          in to the primary master node <ph conkeyref="strings/login-root"/>.</cmd>
      </step>
      
      <step>
        <cmd>Display the hostname of the primary node.</cmd>
        <stepxmp>
          <codeblock>uname -n</codeblock>
        </stepxmp>
        <stepresult>Record the name for use in a subsequent procedure.</stepresult>
      </step>
      
      <step>
        <cmd>Identify the hosts in the ZooKeeper ensemble.</cmd>
        <stepxmp>
          <codeblock>grep -E '^\b*SERVICED_ZK=' /etc/default/serviced</codeblock>
        </stepxmp>
        <stepresult>The result is a list of 1, 3, or 5 hosts, separated by the comma character
          (<codeph>&#44;</codeph>). The master host is always a node in the ZooKeeper
          ensemble.</stepresult>
      </step>
      
      <step>
        <cmd>In separate windows, log in to each of the delegate hosts
          that are nodes in the ZooKeeper ensemble <ph conkeyref="strings/login-root"/>.</cmd>
      </step>
      
      <step>
        <cmd>On the primary master host node, start the <ph keyref="nm-cc"/> resource.</cmd>
        <stepxmp>
          <codeblock>pcs resource enable serviced</codeblock>
        </stepxmp>
      </step>
      
      <step>
        <cmd>On the other ZooKeeper ensemble hosts, start <cmdname>serviced</cmdname>.</cmd>
        <info>The window of time for starting a ZooKeeper ensemble is 
          relatively short. The goal of this step is to start
          <ph keyref="nm-cc"/> on each ensemble node at about the 
          same time, so that each node can participate in electing
          the leader.</info>
        <stepxmp>
          <codeblock>systemctl start serviced</codeblock>
        </stepxmp>
      </step>
      
      <step>
        <cmd>On the primary node, confirm that <cmdname>serviced</cmdname> 
          starts successfully.</cmd>
        <stepxmp>
          <codeblock>journalctl -flu serviced</codeblock>
        </stepxmp>
      </step>
      
      <step>
        <cmd>On the primary node, stop the cluster.</cmd>
        <substeps>
          <substep>
            <cmd>Stop the <cmdname>serviced</cmdname> resource.</cmd>
            <stepxmp>
              <codeblock>pcs resource disable serviced</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Confirm that <cmdname>serviced</cmdname> stops successfully.</cmd>
            <stepxmp>
              <codeblock>journalctl -flu serviced</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Stop the storage resource.</cmd>
            <stepxmp>
              <codeblock>pcs resource disable serviced-storage</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Stop the <cmdname>serviced</cmdname> group.</cmd>
            <stepxmp>
              <codeblock>pcs resource disable serviced-group</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Wait for all cluster resources to stop.</cmd>
            <stepxmp>
              <codeblock>watch pcs status</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>On the primary node, fail over to the secondary node.</cmd>
        <substeps>
          <substep>
            <cmd></cmd>
            <stepxmp>
              <codeblock>pcs cluster standby $(hostname)</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Confirm that the master node switches to passive.</cmd>
            <stepxmp>
              <codeblock>pcs status</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
      
      <step>
        <cmd>Confirm that the storage shows the correct size.</cmd>
        <substeps>
          <substep>
            <cmd>Start the <cmdname>serviced</cmdname> group.</cmd>
            <stepxmp>
              <codeblock>pcs resource ensable serviced-group</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Confirm that the <codeph>serviced-lvm</codeph> resource starts.</cmd>
            <stepxmp>
              <codeblock>pcs status</codeblock>
            </stepxmp>
          </substep>
          <substep>
            <cmd>Confirm that the logical volume of the <codeph>serviced</codeph> thin pool
              shows the correct size.</cmd>
            <stepxmp>
              <codeblock>lvs --options=lv_name,vg_name,lv_size</codeblock>
            </stepxmp>
          </substep>
        </substeps>
      </step>
    </steps>
    <postreq>Complete the startup on one of the master host nodes.
      <ul>
        <li>To complete the startup on the current master node, 
          proceed to <xref keyref="cc-upgrade-ha-resize-start-secondary"/>.</li>
        <li>To complete the startup on the former master node, 
          proceed to <xref keyref="cc-upgrade-ha-resize-start-primary"/>.</li>
      </ul>
    </postreq>
  </taskbody>
</task>
